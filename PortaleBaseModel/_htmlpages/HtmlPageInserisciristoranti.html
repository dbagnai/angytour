<script>
    // <![CDATA[
    $('#divTitleContainer').html('');
    // ]]></script>
<section id="header3-2k" class="mbr-section mbr-section__container article" style="padding-top: 20px; padding-bottom: 40px;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="mbr-section-title display-2">Inserisci il tuo ristorante</h1>
                <h2 class="mbr-section-subtitle">Riempi il form e carica le foto del tuo ristorante tramite il modulo in questa pagina.<br />Valuteremo il materiale inviato e ti comunicheremo l'esito della richiesta di inserimento.</h2>
            </div>
        </div>
    </div>
</section>

<div id="richiedilinkpoint" style="padding-top: 176px; margin-top: -176px;"></div>
<div class="ui-15 bg-light-color" runat="server" id="divContactForm" clientidmode="static" visible="false">
    <div class="container">
        <section class="mbr-section mbr-section__container article" id="header3-a" style="padding-top: 60px; padding-bottom: 10px;">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-12 col-sm-8 tx-dark-color">
                    </div>
                </div>
            </div>
        </section>
        <!-- Ui Form -->
        <div class="ui-form">
            <!-- Heading -->
            <div class="row justify-content-center" style="padding-right: inherit">
                <div class="col-md-8 col-md-offset-2" id="formbtniscrivi">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="ui-input">
                                <!-- Input Box -->
                                <input class="form-control" type="text" name="uname" placeholder="Nome ristorante" runat="server" id="nomebtniscrivi" />
                                <label class="ui-icon"><i class="fa fa-user"></i></label>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="ui-input">
                                <input class="form-control" type="text" name="unname" placeholder="Tipologia cucina .." runat="server" id="tipologiabtniscrivi" />
                                <label class="ui-icon"><i class="fa fa-utensils"></i></label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="ui-input">
                                <input class="form-control" type="text" name="unname" placeholder="Telefono" runat="server" id="telefonobtniscrivi" />
                                <label class="ui-icon"><i class="fa fa-phone"></i></label>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="ui-input">
                                <input type="text" class="form-control" name="unname" placeholder="Email" runat="server" id="emailbtniscrivi" />
                                <label class="ui-icon"><i class="fa fa-envelope-o"></i></label>
                            </div>
                        </div>
                    </div>
                    <div class="ui-input">
                        <textarea class="form-control" rows="2" cols="5" name="q" placeholder="Indirizzo ristorante .." runat="server" id="indirizzobtniscrivi"></textarea>
                        <label class="ui-icon"><i class="fa fa-map-marker-alt"></i></label>

                    </div>
                    <div class="ui-input">
                        <textarea class="form-control" rows="4" cols="5" name="q" placeholder="Descrizione ristorante .." runat="server" id="descrizionebtniscrivi"></textarea>
                        <label class="ui-icon"><i class="fa fa-comments"></i></label>
                    </div>
                    <div class="ui-input text-center">
                        <div class="btn btn-primary" style="width: 200px">
                            <a style="color: #fff; font-size: 0.7rem;display:block" href="#divContactForm" id="uploaddoc" onclick="UploadFiles(this)">Allega Foto</a><br />
                        </div><br />
                        <div style="font-weight: 300; font-size: 1.4rem; color: red" class="w-100" ID="outputbtnuploaddoccontrol"></div><br />
                        <input type="file" name="uploaddoccontrol" id="uploaddoccontrol" multiple="multiple" onchange="fileselected(this)" Style="visibility: hidden;" />

                    </div>
                    <div class="ui-input text-center">
                        <button id="btniscrivi" type="button" class="btn btn-lg btn-block" style="width: 200px" onclick="ConfirmValidationForm(this);">Invia</button>

                    </div>
                    <div class="checkbox text-center">
                        <label>
                            <input type="checkbox" ID="chkprivacybtniscrivi" />
                            <span class="cr"><i class="cr-icon fa fa-check"></i></span>
                            Acconsento al trattamento dei miei dati personali <a target="_blank" href="/I/web/privacy-policy-6">(Leggi Informativa Privacy)</a>
                        </label>
                    </div>
                    <div class="ui-input text-center">
                        <div class="g-recaptcha" id="rcaptcha" data-sitekey="6LccbRMUAAAAAAN14HC8RFxwNMaqdGvJFPQEVinq"></div>
                    </div>
                </div>
                <div style="font-weight: 300; font-size: 1.6rem; color: red" id="divoutputbtniscrivi">
                    <span ID="outputbtniscrivi"></span>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var localmessage = {};
    localmessage.privacy = 'Spuntare la casella per autorizzazione trattamento dati personali per procedere.';
    localmessage.captcha = "Selezionare la casella Captcha di verifica per procedere con l'inserimento.";
    localmessage.validation = "Riempire tutti i campi per procedere.!";
    localmessage.successmsg = "Richiesta inserimento corettamente inserita.";
    localmessage.errormsg = "Errore nell'inserimento della richiesta. Contattate il supporto per procedere.";
    localmessage.tipologia = "rif000003";
    localmessage.inputisvalid = false;
    localmessage.validatemsg = "";

    function ConfirmValidationForm(btnid) {

        var out1 = document.getElementById("divoutput" + btnid.id);

        //($("#aspnetForm").valid()); //Attivo il controllo per la validazione
        //if (!localmessage.inputisvalid) {
        //    out1.innerHTML = localmessage.validatemsg;
        //    return;
        //}


        var chk1 = document.getElementById("chkprivacy" + btnid.id);
        if (!chk1.checked) {
            out1.innerHTML = localmessage.privacy;
            return false;
        } else {
            out1.innerHTML = '';
        }
        var response = grecaptcha.getResponse();
        if (response.length == 0)  //reCaptcha not verified
        {
            out1.innerHTML = localmessage.captcha;
            return false;
        }
        else {
            if (true) { //fare controllo di validazione ...
                /*do work and go for postback*/
                $(btnid).attr("disabled", "")
                //invio nopostback con handler////////////////////////////////////////////////////
                var contactdatas = {};
                contactdatas.chkprivacy = chk1.checked;
                contactdatas.lingua = lng;
                getcontactdataform(contactdatas, btnid, function (contactdatas) {
                    if (contactdatas != null) {
                        //fare inserimento post ristorante e foto
                        preparedataandpost(contactdatas, btnid);

                        //var tastotxt = $(btnid).html();
                        //$(btnid).html("Wait ..");
                        //inviamessaggiomail(lng, contactdatas, function (result) {
                        //    if (result) {
                        //        out1.innerHTML = (result);
                        //        $(btnid).removeAttr("disabled");
                        //        $(btnid).html(tastotxt);
                        //    }
                        //}, tastotxt);
                    } else {
                        out1.innerHTML = localmessage.validation;
                    }

                }, $(btnid));


            } else {
                console.log('not  validated');
                return false;
            }
        }
    }
    function getcontactdataform(contactdatas, btnid, callback) {
        var contactdatas = contactdatas || {};
        contactdatas.idofferta = '';
        contactdatas.titolo = $("[id$='nome" + (btnid).id + "']").val();
        contactdatas.sottotitolo = $("[id$='tipologia" + (btnid).id + "']").val();
        contactdatas.email = $("[id$='email" + (btnid).id + "']").val();
        contactdatas.telefono = $("[id$='telefono" + (btnid).id + "']").val();
        contactdatas.descrizione = $("[id$='descrizione" + (btnid).id + "']").val();
        contactdatas.indirizzo = $("[id$='indirizzo" + (btnid).id + "']").val();
        contactdatas.tipologia = localmessage.tipologia;
        contactdatas.lingua = lng;
        contactdatas.tipo = "post";
        if (contactdatas.titolo == '' || contactdatas.email == '' ||
            contactdatas.telefono == '' || contactdatas.indirizzo == '' ||
            contactdatas.teletipologiafono == '' || contactdatas.descrizione == '') contactdatas = null;

        callback(contactdatas);
    }

    //$("#lnkAttach").click(function () {
    //    $("#uploaddoc").click();
    //});
    function UploadFiles(btnupload) {
        var out1 = document.getElementById("outputbtn" + btnupload.id + "control");
        var response = grecaptcha.getResponse();
        if (response.length == 0)  //reCaptcha not verified
        {
            out1.innerHTML = localmessage.captcha;
            return false;
        }
        else {
            $('#' + btnupload.id + 'control').click()
        }
    }
    function fileselected(uplcontrol) {

        var out1 = document.getElementById("outputbtn" + uplcontrol.id);
        var startbtn = document.getElementById(uplcontrol.id.replace('control', ''));
        $(startbtn).attr("onclick", "")
        out1.innerHTML = "";
        console.log('changed selected files');
        for (var i = 0; i < uplcontrol.files.length; i++) {
            console.log(uplcontrol.files[i].name);
            out1.innerHTML += (uplcontrol.files[i].name);
        }
        //Precarico i files in una directoory temporanea nel server!!!
        uploadfileintmpdir(uplcontrol, startbtn, out1);
    }

    function uploadfileintmpdir(uplcontrol, startbtn, out1) {
        var data = new FormData();
        var fileUpload = uplcontrol;
        var files = fileUpload.files;
        for (var i = 0; i < files.length; i++) {
            (files[i].name);
            data.append(files[i].name, files[i]);
        }
        data.append('q', 'uploadfileinfolder');
        var tastotxt = $(startbtn).html();
        $(startbtn).html("ATTENDI ..");
        $.ajax({
            url: pathAbs + "/lib/hnd/filehnd.ashx",
            global: false,
            contentType: false,
            processData: false,
            cache: false,
            type: "POST",
            //async: false,
            data: data,
            success: function (result) {
                var valoriritorno = JSON.parse(result);
                var stringmsg = "";
                if (valoriritorno.hasOwnProperty("messages")) {
                    stringmsg = valoriritorno["messages"].join();
                }
                var filesimages = "";
                if (valoriritorno.hasOwnProperty("files")) {
                    for (var i = 0; i < valoriritorno["files"].length; i++) {
                        filesimages += "<a style=\"cursor:cell\" link=\"" + valoriritorno["files"][i] + "\" onclick=\"imgdelete(this,'" + out1.id + "')\" ><img class=\"rounded img-thumbnail w-25\" src=\"" + valoriritorno["files"][i] + "\" ></a>";
                    }
                }
                out1.innerHTML = filesimages + '<br/>' + stringmsg;
                //location.replace(result);//reindirizzo alla destinazione indicata dall'handler
                $(uplcontrol).val("");//Svuoto i files già caricati
                $(startbtn).attr("onclick", "UploadFiles(this)")

                $(startbtn).html(tastotxt);
            },
            error: function (result) {
                out1.innerHTML = result.responseText;
            }
        }, tastotxt);
    }
    function imgdelete(file, out1) {
        out1 = document.getElementById(out1);;
        var deleeteconfirm = confirm('Vuoi eliminare la foto?');
        if (deleeteconfirm)
            $.ajax({
                url: pathAbs + "/lib/hnd/filehnd.ashx",
                contentType: "application/json; charset=utf-8",
                global: false,
                cache: false,
                dataType: "text",
                type: "POST",
                //async: false,
                data: { 'q': 'deletefilebypath', 'data': $(file).attr("link") },
                success: function (result) {
                    //if (callback)
                    //    callback(result);
                    var valoriritorno = JSON.parse(result);
                    var stringmsg = "";
                    if (valoriritorno.hasOwnProperty("messages")) {
                        stringmsg = valoriritorno["messages"].join();
                    }
                    var filesimages = "";
                    if (valoriritorno.hasOwnProperty("files")) {

                        for (var i = 0; i < valoriritorno["files"].length; i++) {
                            filesimages += "<a style=\"cursor:cell\" link=\"" + valoriritorno["files"][i] + "\" onclick=\"imgdelete(this,'" + out1.id + "')\" ><img class=\"rounded img-thumbnail w-25\" src=\"" + valoriritorno["files"][i] + "\" ></a>";
                        }
                    }
                    out1.innerHTML = filesimages + '<br/>' + stringmsg;
                },
                error: function (result) {
                    console.log(result.responseText);
                }
            });
    }

    function preparedataandpost(contactdatas, btnid) {
        var data = new FormData();
        data.append('q', 'insertpost');
        data.append('formdata', JSON.stringify(contactdatas));
        var fileUpload = document.getElementById("uploaddoccontrol");;
        //var files = fileUpload.files;
        var files = fileUpload.files;
        for (var i = 0; i < files.length; i++) {
            (files[i].name);
            data.append(files[i].name, files[i]);
        }
        var tastotxt = $(btnid).html();
        $(btnid).html("ATTENDI ..");
        insertPostWithFiles(lng, data, function (result) {
            //Meaaggio finale e svuotamento del FORM!!!
            var out1 = document.getElementById("divoutput" + btnid.id);
            if (result == "") {
                out1.innerHTML = (localmessage.successmsg);
                $("#form" + btnid.id).hide();
            }
            else
                out1.innerHTML = (result);
            $(btnid).removeAttr("disabled");
            $(btnid).html(tastotxt);
        }, tastotxt);
    }
    function insertPostWithFiles(lng, data, callback) {
        var lng = lng || "I";
        var data = data || {};

        $.ajax({
            url: pathAbs + "/lib/hnd/filehnd.ashx",
            global: false,
            contentType: false,
            processData: false,
            cache: false,
            type: "POST",
            //async: false,
            data: data,
            success: function (result) {
                if (callback)
                    callback(result);
                //location.replace(result);//reindirizzo alla destinazione indicata dall'handler
            },
            error: function (result) {
                if (callback)
                    callback(result.responseText);
            }
        });
    }


    //$(document).ready(function () {
    //    validateinit();
    //});

    //function validateinit() {
    //    $("#aspnetForm").validate({
    //        ignore: [], //Abilita il controllo dei campi Hidden!
    //        rules: {
    //            descrizionebtniscrivi: {
    //                required: true,
    //                minlength: 250,
    //                noSpacesonlytext: true
    //            }
    //        },
    //        messages: {
    //            descrizionebtniscrivi: {
    //                required: "Inserisci la descrizione del ristorante",
    //                minlength: "Nome almeno 250 caratteri"
    //            }
    //        }, showErrors: function (errorMap, errorList) {
    //            if (this.numberOfInvalids() == 0) {
    //                localmessage.inputisvalid = true;
    //                localmessage.validatemsg = "";
    //            }
    //            else {
    //                localmessage.inputisvalid = false;
    //                localmessage.validatemsg = "Impossibile inviare. Numero di errori relevati: " + this.numberOfInvalids();
    //                if (errorList.length > 0) {
    //                    for (var x = 0; x < errorList.length; x++) {
    //                        localmessage.validatemsg += "<br/>\n\u25CF " + errorList[x].message;
    //                    }
    //                }
    //            }
    //            this.defaultShowErrors();
    //        }
    //    });
    //}


</script>